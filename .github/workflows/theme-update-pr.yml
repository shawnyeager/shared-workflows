name: Theme Update PR

on:
  workflow_call:
    inputs:
      theme_module:
        required: false
        type: string
        default: 'github.com/shawnyeager/tangerine-theme'
        description: 'Theme module path'
      go_version:
        required: false
        type: string
        default: '1.25.3'
      hugo_version:
        required: false
        type: string
        default: '0.152.2'
    secrets:
      GH_PAT:
        required: true
        description: 'GitHub PAT for creating PRs'

jobs:
  update-theme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ inputs.hugo_version }}
          extended: true

      - name: Check for theme updates
        id: check
        run: |
          THEME="${{ inputs.theme_module }}"
          echo "Checking current theme version..."
          BEFORE=$(grep "$THEME" go.mod | head -n1)
          echo "Current: $BEFORE"

          # Reset to master branch to avoid "unknown revision" errors from rebased commits
          echo "Resetting to master branch..."
          sed -i "s|$THEME v[^ ]*|$THEME master|" go.mod

          echo "Updating theme..."
          GOPROXY=direct hugo mod get -u "$THEME"
          hugo mod tidy

          AFTER=$(grep "$THEME" go.mod | head -n1)
          echo "After update: $AFTER"

          if [ "$BEFORE" != "$AFTER" ]; then
            echo "Theme was updated!"
            echo "updated=true" >> $GITHUB_OUTPUT

            # Extract commit hash (12 hex chars, handles optional // indirect suffix)
            HASH=$(echo "$AFTER" | grep -oP '[a-f0-9]{12}(?=( |$))')
            echo "hash=$HASH" >> $GITHUB_OUTPUT
          else
            echo "No theme updates available"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT }}
          commit-message: "chore: update tangerine-theme module"
          committer: "GitHub Actions <actions@github.com>"
          author: "GitHub Actions <actions@github.com>"
          branch: theme-update-${{ github.run_number }}
          delete-branch: true
          title: "Update tangerine-theme module"
          body: |
            ## Theme Update Available

            Auto-generated PR to update tangerine-theme module.

            **Commit:** `${{ steps.check.outputs.hash }}`

            ### Deploy Preview

            Netlify will automatically build a **FREE deploy preview** for this PR.
            Check the preview URL below before merging.

            ### Next Steps

            1. Wait for Netlify deploy preview to complete
            2. Review the preview URL
            3. Test site functionality
            4. Merge this PR when satisfied

            Merging will trigger ONE production build (15 credits).

            ---

            Generated by GitHub Actions
          labels: dependencies,automated,theme-update
